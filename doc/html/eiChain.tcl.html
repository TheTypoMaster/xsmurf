<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- Generated by TclDoc 0.3 -->
<html>
<head><title>eiChain.tcl</title></head>
<body bgcolor="#ffffff">
<font size="-2">
<a href="xsmurf_tcl_lib_intro.html">Overview</a> | Index by:  <a href="index_main.html#eiChain.tcl">file name</a> |
<a href="index_main.html#byprocname">procedure name</a> |
<a href="index_main.html#bycall">procedure call</a> |
<a href="index_annot_full.html">annotation</a>
</font>
<hr>
<strong>eiChain.tcl</strong>
(<a href="eiChain.tcl-annot.html">annotations</a> | <a href="eiChain.tcl.txt">original source</a>)
<p>
<pre>
<font color="#208020"># eiChain.tcl --</font>
<font color="#208020">#</font>
<font color="#208020">#       This file implements the Tcl code for ...</font>
<font color="#208020">#</font>
<font color="#208020">#   Copyright 1999 Centre de Recherche Paul Pascal, Bordeaux, France.</font>
<font color="#208020">#   Written by Nicolas Decoster.</font>
<font color="#208020">#</font>
<font color="#208020">#  RCS : $Id: eiChain.tcl,v 1.4 1999/05/09 20:25:01 decoster Exp $</font>
<font color="#208020">#</font>
<font color="#208020">#   Modified by P. Kestener (add options -rm_lines_by_size, -isolated </font>
<font color="#208020">#                            and -swap_bytes)</font>

package provide eiChain 0.0

<font color="#208020">#package require extImage</font>

<font color="#208020"># chain --</font>
<font color="#208020"># usage: chain str float int int [... options ...]</font>
<font color="#208020">#</font>
<font color="#208020">#   Horizontal and vertical chain of a serie of ext images.</font>
<font color="#208020">#   Based on hsearch (mmto), ssm(3mto) and vchain or vchain2</font>
<font color="#208020">#   NB : vchain -&gt; mlm_vert_chain_TclCmd_ in interpreter/wt2d_cmds.c</font>
<font color="#208020">#         mlm_vert_chain_TclCmd_ -&gt; vert_chain in wt2d/Chain.c</font>
<font color="#208020">#</font>
<font color="#208020">#</font>
<font color="#208020"># Parameters:</font>
<font color="#208020">#   string - Base name of the ext images.</font>
<font color="#208020">#   float  - First scale.</font>
<font color="#208020">#   int    - Number of octaves.</font>
<font color="#208020">#   int    - Number of voices.</font>
<font color="#208020">#</font>
<font color="#208020"># Options:</font>
<font color="#208020">#   -filename string: Specify a different base name for the files that contains</font>
<font color="#208020">#       the ext images.</font>
<font color="#208020">#</font>
<font color="#208020">#   -procfilename string: Specify a different base name for the files that</font>
<font color="#208020">#       contains the ext images.</font>
<font color="#208020">#</font>
<font color="#208020">#   -firstsid int: First scale id to begin the chain.</font>
<font color="#208020">#</font>
<font color="#208020">#   -lastsid int: Last scale id to begin the chain.</font>
<font color="#208020">#</font>
<font color="#208020">#   -boxratio float: Used to change the size of the &#34;searching box&#34; for </font>
<font color="#208020">#       vertical chain (see vchain command).</font>
<font color="#208020">#</font>
<font color="#208020">#   -keepup  [float] : threshold to apply to each ext image before </font>
<font color="#208020">#       doing anything else. (old name of this option : -thresh)</font>
<font color="#208020">#</font>
<font color="#208020">#   -keeplow [float] : threshold ... but keep low modulus instead of great.</font>
<font color="#208020">#</font>
<font color="#208020">#   -rm_lines_by_size [d d] : use command rm_by_size command (see its own</font>
<font color="#208020">#        help message). This operation is done after keepup or keeplow</font>
<font color="#208020">#               </font>
<font color="#208020">#   -similitude float: See vchain command.</font>
<font color="#208020">#         float used in vchain -&gt; mlm_vert_chain_TclCmd_ (interpreter/wt2d_cmds.c)</font>
<font color="#208020">#         -&gt; vert_chain (wt2d/Chain.c)  !!!</font>
<font color="#208020">#         used to test ext-&gt;arg of to extrema that we're going to chain</font>
<font color="#208020">#         and also to test mod_ratio = up_ext-&gt;mod / do_ext-&gt;mod</font>
<font color="#208020">#         default value is 0.8 </font>
<font color="#208020">#</font>
<font color="#208020">#   -nomsg: Do not put any message during processing.</font>
<font color="#208020">#</font>
<font color="#208020">#   -ssmargs list: List of args to append to the ssm command.</font>
<font color="#208020">#         recall that ssm search the local maxima of each line of an ext image.</font>
<font color="#208020">#         ssm -&gt; search_single_max_TclCmd_ (in interpreter/wt2d_cmds.c)</font>
<font color="#208020">#             -&gt; search_single_max         (in wt2d/single_max.c)</font>
<font color="#208020">#</font>
<font color="#208020">#   -ecut list: Apply ecut command to each ext image. The list is append to the</font>
<font color="#208020">#      ecut command.</font>
<font color="#208020">#</font>
<font color="#208020">#   -isolated: Specify that the maxima are isolated (i.e. there is no contour</font>
<font color="#208020">#      lines). We don't need to do horizontal chain, we use \&#34;-grhack\&#34; option</font>
<font color="#208020">#      of eload, and we must use the vchain2 command. With this option the</font>
<font color="#208020">#      option \&#34;-ssmargs\&#34; has no effect.</font>
<font color="#208020">#</font>
<font color="#208020">#   -swap_bytes : swap bytes when reading data (usefull when working </font>
<font color="#208020">#                 on ext-images created on another system: unix, PC-linux, ...)</font>
<font color="#208020">#</font>
<font color="#208020">#   -noload : assume that ext images are already loaded under the name </font>
<font color="#208020">#             &#34;total$base&#34; (usefull when you want to do multiple chain </font>
<font color="#208020">#             with large data for which the load step can be long)</font>
<font color="#208020">#</font>
<font color="#208020">#</font>
<font color="#208020"># Return value:</font>
<font color="#208020">#   None.</font>

<strong><a name="chain_87">proc <a href="eiChain.tcl-annot.html#chain">chain</a></a></strong><a name="chain"></a> {name aMin nO nV args} {

    set fileName $name
    set suffixe {}
    set firstSid 0
    set firstFileSid 0
    set lastSid [expr { $nO*$nV }]
    set lastFileSid [expr { $nO*$nV }]
    set boxRatio 1
    set thresh 0
    set similitude 0.8
    set isNomsg no
    set ssmArgs {}
    set isEcut no
    set ecutArgs {}
    set isProcfilename no
    set isIsolated no
    set isKeepUp no
    set isKeepLow no
    set isRmlinesbysize no
    set isSwap no
    set isNoload no

    <font color="#208020"># Arguments analysis</font>

    while {[string match -* $args]} {
	switch -exact -- [lindex $args 0] {
	    -filename {
		set fileName [lindex $args 1]
		set args [lreplace $args 0 1]
	    }
	    -suffixe {
		set suffixe [lindex $args 1]
		set args [lreplace $args 0 1]
	    }
	    -procfilename {
		set procfileName [lindex $args 1]
		set isProcfilename yes
		set args [lreplace $args 0 1]
	    }
	    -firstsid {
		set firstSid [lindex $args 1]
		set args [lreplace $args 0 1]
	    }
	    -firstfilesid {
		set firstFileSid [lindex $args 1]
		set args [lreplace $args 0 1]
	    }
	    -lastsid {
		set lastSid [lindex $args 1]
		set args [lreplace $args 0 1]
	    }
	    -lastfilesid {
		set lastFileSid [lindex $args 1]
		set args [lreplace $args 0 1]
	    }
	    -boxratio {
		set boxRatio [lindex $args 1]
		set args [lreplace $args 0 1]
	    }
	    -keepup {
		<font color="#208020"># old name of this option -thresh</font>
		set thresh [lindex $args 1]
		set args [lreplace $args 0 1]
		set isKeepUp yes
	    }
	    -keeplow {
		set thresh [lindex $args 1]
		set args [lreplace $args 0 1]
		set isKeepLow yes
	    }
	    -rm_lines_by_size {
		set length_min [lindex $args 1]
		set length_max [lindex $args 2]
		set args [lreplace $args 0 2]
		set isRmlinesbysize yes
	    }
	    -similitude {
		set similitude [lindex $args 1]
		set args [lreplace $args 0 1]
	    }
	    -nomsg {
		set isNomsg yes
		set args [lreplace $args 0 0]
	    }
	    -ssmargs {
		set ssmArgs [lindex $args 1]
		set args [lreplace $args 0 1]
	    }
	    -ecut {
		set isEcut yes
		set ecutArgs [lindex $args 1]
		set args [lreplace $args 0 1]
	    }
	    -isolated {
		set isIsolated yes
		set args [lreplace $args 0 0]
	    }
	    -swap_bytes {
		set isSwap yes
		set args [lreplace $args 0 0]		
	    }
	    -noload {
		set isNoload yes
		set args [lreplace $args 0 0]		
	    }
	    default {
		return -code error &#34;unknown option \&#34;[lindex $args 0]\&#34;&#34;
	    }
	}
    }

    set scale_max [expr $aMin*pow(2,($nO-1)+($nV/double($nV)))]
    set scale_max [expr $scale_max*(6/0.86)]

    set memSid 0
    set fileSid 0
    for {set o 0} {$o &lt; $nO} {incr o} {
	for {set v 0} {$v &lt; $nV} {incr v; incr memSid; incr fileSid} {
	    if {$memSid &lt; $firstSid || $memSid &gt; $lastSid} {
		continue
	    }
	    if {$fileSid &lt; $firstFileSid || $fileSid &gt; $lastFileSid } {
		continue
	    }

	    set scale [expr $aMin*pow(2,$o+($v/double($nV)))]
	    set scale [expr $scale*(6/0.86)]

	    if {$isNomsg == &#34;no&#34;} {
		<a name="dputs(1)"><a href="./new_puts.tcl.html#dputs_12">dputs</a></a> &#34;  Octave $o - voice $v - scale $scale ( $memSid )&#34;
	    }

	    set memSidF [format &#34;%.3d&#34; $memSid]
	    set sidf $memSidF
	    set fileSidF [format &#34;%.3d&#34; $fileSid]

	    set prevMemSid [expr { $memSid - 1 }]
	    set prevMemSidF [format &#34;%.3d&#34; $prevMemSid]

	    set zeEi ${name}${memSidF}
	    set zePrevEi ${name}${prevMemSidF}

	    if {$isProcfilename == &#34;no&#34;} {
		set zeFileName ${fileName}${fileSidF}
	    } else {
		set zeFileName [$procfileName ${name} ${memSid}]
	    }

	    if {$isNoload == &#34;no&#34;} {
		if {$isIsolated == &#34;no&#34;} {
		    if {$isSwap == &#34;no&#34;} {
			eload ${zeFileName}${suffixe} $zeEi
		    } else {
			eload ${zeFileName}${suffixe} $zeEi -swap_bytes
		    }
		} else {
		    if {$isSwap == &#34;no&#34;} {
			eload ${zeFileName}${suffixe} $zeEi -grhack
		    } else {
			eload ${zeFileName}${suffixe} $zeEi -grhack -swap_bytes
		    }
		}
		if {$isEcut == &#34;yes&#34;} {
		    eval ecut $zeEi $zeEi $ecutArgs
		}
	    } else {
		if {$isEcut == &#34;yes&#34;} {
		    eval ecut total$zeEi $zeEi $ecutArgs
		}
	    }


	    if {$isKeepUp == &#34;yes&#34;} {
		ekeep $zeEi $zeEi $thresh
	    } elseif {$isKeepLow == &#34;yes&#34;} {
		ekeep $zeEi $zeEi $thresh -keeplow 
	    }

	    if {$isRmlinesbysize == &#34;yes&#34; &amp; $memSid == 0} {
		rm_by_size $zeEi -min ${length_min} -max ${length_max} -new $zeEi
	    }

	    if {$isIsolated == &#34;no&#34;} {
		hsearch $zeEi
		<font color="#208020"># ssm : search single max</font>
		eval ssm $zeEi $ssmArgs
		set vchainCmdName vchain
	    } else {
		set vchainCmdName vchain2
	    }

	    set boxSize [expr int($boxRatio*log($scale)*2/log(2))]
	    if {$prevMemSid == $firstSid} {
		$vchainCmdName $zePrevEi $zeEi $boxSize $similitude -first
	    } else {
		if {$prevMemSid &gt; $firstSid} {
		    $vchainCmdName $zePrevEi $zeEi $boxSize $similitude
		}
	    }
	}   
    }
    return
}



<font color="#208020"># chainn --</font>
<font color="#208020"># usage: chainn str float int int int int [... options ...]</font>
<font color="#208020">#</font>
<font color="#208020">#   Same as chain not for all scales but for scales beetween scale1 ans scale2.</font>
<font color="#208020">#   Horizontal and vertical chain of a serie of ext images.</font>
<font color="#208020">#   Be careful giving valid parameters for scale1 and scale2</font>
<font color="#208020">#</font>
<font color="#208020"># Parameters:</font>
<font color="#208020">#   string - Base name of the ext images.</font>
<font color="#208020">#   float  - First scale.</font>
<font color="#208020">#   int    - Total number of octaves.</font>
<font color="#208020">#   int    - Number of voices.</font>
<font color="#208020">#   int    - No scale1.</font>
<font color="#208020">#   int    - No scale2.</font>
<font color="#208020">#</font>
<font color="#208020"># Options:</font>
<font color="#208020">#   -filename string: Specify a different base name for the files that contains</font>
<font color="#208020">#       the ext images.</font>
<font color="#208020">#   -procfilename string: Specify a different base name for the files that contains</font>
<font color="#208020">#       the ext images.</font>
<font color="#208020">#   -firstsid int: First scale id to begin the chain.</font>
<font color="#208020">#   -lastsid int: Last scale id to begin the chain.</font>
<font color="#208020">#   -boxratio float: Used to change the size of the &#34;searching box&#34; for vertical</font>
<font color="#208020">#       chain (see vchain command).</font>
<font color="#208020">#   -thresh float: threshold to apply to each ext image before doing anything</font>
<font color="#208020">#       else.</font>
<font color="#208020">#   -similitude float: See vchain command.</font>
<font color="#208020">#   -nomsg: Do not put any message during processing.</font>
<font color="#208020">#   -ssmargs list: List of args to append to the ssm command.</font>
<font color="#208020">#   -ecut list: Apply ecut command to each ext image. The list is append to the</font>
<font color="#208020">#      ecut command.</font>
<font color="#208020">#   -isolated: Specify that the maxima are isolated (i.e. there is no contour</font>
<font color="#208020">#      lines). We don't need to do horizontal chain, we use \&#34;-grhack\&#34; option</font>
<font color="#208020">#      of eload, and we must use the vchain2 command. With this option the</font>
<font color="#208020">#      option \&#34;-ssmargs\&#34; has no effect.</font>
<font color="#208020">#</font>
<font color="#208020"># Return value:</font>
<font color="#208020">#   None.</font>

<strong><a name="chainn_333">proc <a href="eiChain.tcl-annot.html#chainn">chainn</a></a></strong><a name="chainn"></a> {name aMin nO nV nscale1 nscale2 args} {

    set fileName $name
    set firstSid $nscale1
    set firstFileSid $nscale1
    set lastSid $nscale2
    set lastFileSid $nscale2
    set boxRatio 1
    set thresh 0
    set similitude 0.8
    set isNomsg no
    set ssmArgs {}
    set isEcut no
    set ecutArgs {}
    set isProcfilename no
    set isIsolated no

    <font color="#208020"># Arguments analysis</font>

    while {[string match -* $args]} {
	switch -exact -- [lindex $args 0] {
	    -filename {
		set fileName [lindex $args 1]
		set args [lreplace $args 0 1]
	    }
	    -procfilename {
		set procfileName [lindex $args 1]
		set isProcfilename yes
		set args [lreplace $args 0 1]
	    }
	    -firstsid {
		set firstSid [lindex $args 1]
		set args [lreplace $args 0 1]
	    }
	    -firstfilesid {
		set firstFileSid [lindex $args 1]
		set args [lreplace $args 0 1]
	    }
	    -lastsid {
		set lastSid [lindex $args 1]
		set args [lreplace $args 0 1]
	    }
	    -lastfilesid {
		set lastFileSid [lindex $args 1]
		set args [lreplace $args 0 1]
	    }
	    -boxratio {
		set boxRatio [lindex $args 1]
		set args [lreplace $args 0 1]
	    }
	    -thresh {
		set thresh [lindex $args 1]
		set args [lreplace $args 0 1]
	    }
	    -similitude {
		set similitude [lindex $args 1]
		set args [lreplace $args 0 1]
	    }
	    -nomsg {
		set isNomsg yes
		set args [lreplace $args 0 0]
	    }
	    -ssmargs {
		set ssmArgs [lindex $args 1]
		set args [lreplace $args 0 1]
	    }
	    -ecut {
		set isEcut yes
		set ecutArgs [lindex $args 1]
		set args [lreplace $args 0 1]
	    }
	    -isolated {
		set isIsolated yes
		set args [lreplace $args 0 0]
	    }
	    default {
		return -code error &#34;unknown option \&#34;[lindex $args 0]\&#34;&#34;
	    }
	}
    }
    

    set o1 [expr int(floor($nscale1/$nV))]
    set v1 [expr $nscale1-$o1*$nV]
    set o2 [expr int(floor($nscale2/$nV))]
    set v2 [expr $nscale1-$o2*$nV]
    
    if { $nscale1 &gt; $nscale2 } {
	return -code error &#34;wrong scales : nscale1 must be &lt;= to nscale2&#34;
    } elseif { $o1 &gt; $nO } {
	return -code error &#34;wrong scales&#34;
    } elseif { $o2 &gt; $nO } {
	return -code error &#34;wrong scales&#34;
    }

    set scale_max [expr $aMin*pow(2,($nO-1)+($nV/double($nV)))]
    set scale_max [expr $scale_max*(6/0.86)]
    set scale1 [expr $aMin*pow(2,$o1+($v1/double($nV)))]
    set scale1 [expr $scale1*(6/0.86)]
    set scale2 [expr $aMin*pow(2,$o2+($v2/double($nV)))]
    set scale2 [expr $scale2*(6/0.86)]

    set memSid $nscale1
    set fileSid $nscale1
    for {set nscale $nscale1} {$nscale &lt;= $nscale2} {incr nscale; incr memSid; incr fileSid} {
	if {$memSid &lt; $firstSid || $memSid &gt; $lastSid} {
		continue
	}
	
	if {$fileSid &lt; $firstFileSid || $fileSid &gt; $lastFileSid } {
		continue
	}
	
	set o [expr int(floor($nscale/$nV))]
	set v [expr $nscale-$o*$nV]
	set scale [expr $aMin*pow(2,$o+($v/double($nV)))]
	set scale [expr $scale*(6/0.86)]
	
	if {$isNomsg == &#34;no&#34;} {
		<a name="dputs(2)"><a href="./new_puts.tcl.html#dputs_12">dputs</a></a> &#34;  Octave $o - voice $v - scale $scale ( nscale $nscale )&#34;
	}
	
	set memSidF [format &#34;%.3d&#34; $memSid]
	set sidf $memSidF
	set fileSidF [format &#34;%.3d&#34; $fileSid]
	
	set prevMemSid [expr { $memSid - 1 }]
	set prevMemSidF [format &#34;%.3d&#34; $prevMemSid]
	
	set zeEi ${name}${memSidF}
	set zePrevEi ${name}${prevMemSidF}
	
	if {$isProcfilename == &#34;no&#34;} {
	    set zeFileName ${fileName}${fileSidF}
	} else {
	    set zeFileName [$procfileName ${name} ${memSid}]
	}
	
	if {$isIsolated == &#34;no&#34;} {
	    eload ${zeFileName} $zeEi
	} else {
	    eload ${zeFileName} $zeEi -grhack
	}
	
	if {$isEcut == &#34;yes&#34;} {
	    eval ecut $zeEi $zeEi $ecutArgs
	}
	
	if {$thresh &gt; 0} {
	    ekeep $zeEi $zeEi $thresh
	}
	
	if {$isIsolated == &#34;no&#34;} {
	    hsearch $zeEi
	    eval ssm $zeEi $ssmArgs
	    set vchainCmdName vchain
	} else {
	    set vchainCmdName vchain2
	}
	
	set boxSize [expr int($boxRatio*log($scale)*2/log(2))]
	
	if {$prevMemSid == $firstSid} {
	    $vchainCmdName $zePrevEi $zeEi $boxSize $similitude -first
	} else {
	    if {$prevMemSid &gt; $firstSid} {
		$vchainCmdName $zePrevEi $zeEi $boxSize $similitude
	    }
	}   
    }
    return
}

</pre>
<hr>
<font size="-2">
<a href="xsmurf_tcl_lib_intro.html">Overview</a> | Index by:  <a href="index_main.html#byfilename">file name</a> |
<a href="index_main.html#byprocname">procedure name</a> |
<a href="index_main.html#bycall">procedure call</a> |
<a href="index_annot_full.html">annotation</a><br>
<cite>File generated 2008-04-03 at 09:49.</cite>
</font>
</body>
</html>
